<script>
// ... (previous JavaScript code remains the same until line 1954)

function getLeavesForDate(dateString) {
    const date = new Date(dateString);
    const result = [];
    
    leaveRequests.forEach(leave => {
        const startDate = new Date(leave.startDate);
        const endDate = new Date(leave.endDate);
        
        if (date >= startDate && date <= endDate) {
            const employee = employees.find(emp => emp.id === leave.employeeId);
            if (employee) {
                result.push({
                    ...leave,
                    employeeName: employee.name
                });
            }
        }
    });
    
    return result;
}

function previousMonth() {
    currentDate.setMonth(currentDate.getMonth() - 1);
    generateCalendar();
}

function nextMonth() {
    currentDate.setMonth(currentDate.getMonth() + 1);
    generateCalendar();
}

function showLeaveDetails(leaveId) {
    selectedLeaveId = leaveId;
    const leave = leaveRequests.find(req => req.id === leaveId);
    
    if (!leave) return;
    
    const employee = employees.find(emp => emp.id === leave.employeeId);
    const leaveClass = leaveTypeClasses[leave.leaveType] || '';
    
    document.getElementById('leaveDetailsContent').innerHTML = `
        <div>
            <h3 class="font-medium text-gray-900 mb-1">Employee</h3>
            <p class="text-gray-700">${employee?.name || 'Unknown'} (${employee?.position || 'Position not specified'})</p>
        </div>
        <div class="flex items-center">
            <span class="leave-dot ${leaveClass}"></span>
            <h3 class="font-medium text-gray-900 mb-1">Leave Type</h3>
        </div>
        <p class="text-gray-700">${leave.leaveType}</p>
        <div>
            <h3 class="font-medium text-gray-900 mb-1">Dates</h3>
            <p class="text-gray-700">${formatDate(leave.startDate)} to ${formatDate(leave.endDate)} (${leave.duration} days)</p>
        </div>
        <div>
            <h3 class="font-medium text-gray-900 mb-1">Status</h3>
            <p class="text-gray-700"><span class="${getStatusClass(leave.status)} px-2 py-1 rounded-full">${leave.status.toUpperCase()}</span></p>
        </div>
        <div>
            <h3 class="font-medium text-gray-900 mb-1">Reason</h3>
            <p class="text-gray-700">${leave.reason}</p>
        </div>
    `;
    
    // Show approval buttons if admin and leave is pending
    const approvalButtons = document.getElementById('leaveApprovalButtons');
    if (isAdmin && leave.status === 'pending') {
        approvalButtons.classList.remove('hidden');
    } else {
        approvalButtons.classList.add('hidden');
    }
    
    document.getElementById('leaveDetailsModal').classList.remove('hidden');
}

function closeLeaveDetailsModal() {
    document.getElementById('leaveDetailsModal').classList.add('hidden');
}

function approveLeaveRequest() {
    const leaveIndex = leaveRequests.findIndex(req => req.id === selectedLeaveId);
    if (leaveIndex !== -1) {
        leaveRequests[leaveIndex].status = 'approved';
        alert('Leave request approved successfully!');
        populateLeaveRequestsTable();
        generateCalendar();
        updateDashboard();
        closeLeaveDetailsModal();
    }
}

function rejectLeaveRequest() {
    const leaveIndex = leaveRequests.findIndex(req => req.id === selectedLeaveId);
    if (leaveIndex !== -1) {
        leaveRequests[leaveIndex].status = 'rejected';
        alert('Leave request rejected.');
        populateLeaveRequestsTable();
        generateCalendar();
        updateDashboard();
        closeLeaveDetailsModal();
    }
}

function populateEmployeesTable() {
    if (!isAdmin) return;
    
    const tableBody = document.getElementById('employeesTableBody');
    tableBody.innerHTML = '';
    
    employees.forEach(employee => {
        if (employee.id === currentUser.id) return; // Skip current admin
        
        const row = document.createElement('tr');
        row.className = 'hover:bg-gray-50';
        row.innerHTML = `
            <td class="py-2 px-3 text-sm text-gray-700">${employee.id}</td>
            <td class="py-2 px-3 text-sm text-gray-700">${employee.name}</td>
            <td class="py-2 px-3 text-sm text-gray-700">${employee.email}</td>
            <td class="py-2 px-3 text-sm text-gray-700">${employee.position}</td>
            <td class="py-2 px-3 text-sm text-gray-700">${employee.department}</td>
            <td class="py-2 px-3 text-sm text-gray-700">
                <button onclick="deleteEmployee(${employee.id})" class="text-red-600 hover:text-red-800">
                    <i class="fas fa-trash-alt"></i>
                </button>
            </td>
        `;
        tableBody.appendChild(row);
    });
}

function deleteEmployee(employeeId) {
    if (!confirm('Are you sure you want to delete this employee?')) return;
    
    employees = employees.filter(emp => emp.id !== employeeId);
    populateEmployeesTable();
}

function showAddEmployeeModal() {
    document.getElementById('addEmployeeModal').classList.remove('hidden');
}

function closeAddEmployeeModal() {
    document.getElementById('addEmployeeModal').classList.add('hidden');
}

function addEmployee(event) {
    event.preventDefault();
    
    const name = document.getElementById('employeeName').value;
    const email = document.getElementById('employeeEmail').value;
    const position = document.getElementById('employeePosition').value;
    const department = document.getElementById('employeeDepartment').value;
    const employeeType = document.getElementById('employeeType').value;
    const password = document.getElementById('initialPassword').value;
    
    if (employees.some(emp => emp.email === email)) {
        alert('An employee with this email already exists.');
        return;
    }
    
    const newEmployee = {
        id: Math.max(...employees.map(emp => emp.id)) + 1,
        name,
        email,
        position,
        department,
        isAdmin: employeeType === 'admin',
        password: password
    };
    
    employees.push(newEmployee);
    populateEmployeesTable();
    document.getElementById('addEmployeeForm').reset();
    closeAddEmployeeModal();
    
    alert(`Employee ${name} added successfully!`);
}

function populateLeaveRequestsTable() {
    if (!isAdmin) return;
    
    const tableBody = document.getElementById('leaveRequestsTableBody');
    tableBody.innerHTML = '';
    
    const sortedRequests = [...leaveRequests].sort((a, b) => new Date(b.submittedAt) - new Date(a.submittedAt));
    
    sortedRequests.forEach(request => {
        const employee = employees.find(emp => emp.id === request.employeeId);
        if (!employee) return;
        
        const row = document.createElement('tr');
        row.className = 'hover:bg-gray-50';
        row.innerHTML = `
            <td class="py-2 px-3 text-sm text-gray-700">${employee.name}</td>
            <td class="py-2 px-3 text-sm text-gray-700">${request.leaveType}</td>
            <td class="py-2 px-3 text-sm text-gray-700">${formatDate(request.startDate)} - ${formatDate(request.endDate)}</td>
            <td class="py-2 px-3 text-sm text-gray-700">${request.duration} days</td>
            <td class="py-2 px-3 text-sm text-gray-700">
                <span class="${getStatusClass(request.status)} px-2 py-1 rounded-full">${request.status.toUpperCase()}</span>
            </td>
            <td class="py-2 px-3 text-sm text-gray-700">
                <button onclick="showLeaveDetails(${request.id})" class="text-blue-600 hover:text-blue-800">
                    <i class="fas fa-eye"></i>
                </button>
            </td>
        `;
        tableBody.appendChild(row);
    });
}
</script>
